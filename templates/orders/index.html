{% extends "layout_base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-2xl font-bold">Orders Dashboard</h1>
        <div class="flex gap-3">
            <button onclick="refreshOrders()" class="btn btn-secondary">
                <span class="icon">🔄</span> Refresh
            </button>
            <button onclick="syncOrders()" class="btn btn-primary">
                <span class="icon">⚡</span> Instant Sync
            </button>
            <button onclick="fullSyncOrders()" class="btn btn-accent">
                <span class="icon">📥</span> Full Sync
            </button>
        </div>
    </div>

    <!-- Date Filter Status -->
    <div id="dateFilterStatus" class="hidden mb-4">
        <div class="glass p-3 inline-flex items-center gap-2 text-sm">
            <span class="text-blue-400">📅</span>
            <span class="text-white/80">Showing orders for: </span>
            <span id="dateFilterRange" class="font-medium text-blue-300"></span>
            <button onclick="clearDateFilter()" class="ml-2 text-white/60 hover:text-white">✕</button>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8" id="metricsCards">
        <!-- Cards will be populated by JS -->
        <div class="glass animate-pulse h-24"></div>
        <div class="glass animate-pulse h-24"></div>
        <div class="glass animate-pulse h-24"></div>
        <div class="glass animate-pulse h-24"></div>
    </div>

    <!-- Filters -->
    <div class="glass p-4 mb-6">
        <div class="flex flex-wrap gap-4">
            <!-- Search -->
            <div class="flex-1 min-w-[200px]">
                <input type="text" id="searchInput" class="form-input w-full" placeholder="Search orders..." />
            </div>

            <!-- Status Filter -->
            <div class="w-48">
                <select id="statusFilter" class="form-input w-full">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="processing">Processing</option>
                    <option value="ready_to_pack">Ready to Pack</option>
                    <option value="packed">Packed</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>

            <!-- Date Range -->
            <div class="flex gap-2">
                <input type="date" id="startDate" class="form-input" />
                <input type="date" id="endDate" class="form-input" />
            </div>

            <!-- Payment Method -->
            <div class="w-36">
                <select id="paymentFilter" class="form-input w-full">
                    <option value="">All Payments</option>
                    <option value="cod">COD</option>
                    <option value="prepaid">Prepaid</option>
                </select>
            </div>

            <!-- Clear Filters -->
            <button onclick="clearFilters()" class="btn btn-secondary">
                Clear Filters
            </button>
        </div>

        <!-- Quick Filters -->
        <div class="flex gap-2 mt-4">
            <button onclick="applyQuickFilter('pending')" class="quick-filter">
                📋 Pending
            </button>
            <button onclick="applyQuickFilter('engraving')" class="quick-filter">
                ✨ Engraving Queue
            </button>
            <button onclick="applyQuickFilter('packed')" class="quick-filter">
                📦 Packed not Shipped
            </button>
            <button onclick="applyQuickFilter('rto')" class="quick-filter">
                ↩️ RTO/NDR
            </button>
            <button onclick="applyQuickFilter('disputed')" class="quick-filter">
                ⚠️ Disputes
            </button>
        </div>
        
        <!-- Date Quick Filters -->
        <div class="flex gap-2 mt-4">
            <button onclick="applyDateFilter('today')" class="quick-filter bg-blue-500/20 hover:bg-blue-500/30 border-blue-500/30">
                📅 Today
            </button>
            <button onclick="applyDateFilter('tomorrow')" class="quick-filter bg-green-500/20 hover:bg-green-500/30 border-green-500/30">
                🚀 Tomorrow
            </button>
            <button onclick="applyDateFilter('last7')" class="quick-filter bg-purple-500/20 hover:bg-purple-500/30 border-purple-500/30">
                📊 Last 7 Days
            </button>
            <button onclick="applyDateFilter('last30')" class="quick-filter bg-orange-500/20 hover:bg-orange-500/30 border-orange-500/30">
                📈 Last 30 Days
            </button>
            <button onclick="clearDateFilter()" class="quick-filter bg-gray-500/20 hover:bg-gray-500/30 border-gray-500/30">
                🗑️ Clear Date Filter
            </button>
        </div>
    </div>

    <!-- Sync Progress Bar (Hidden by default) -->
    <div id="syncProgress" class="glass p-4 mb-6 hidden">
        <div class="flex items-center justify-between mb-2">
            <div class="font-medium">🔄 Full Sync in Progress</div>
            <div id="syncStatus" class="text-sm text-white/60">Initializing...</div>
        </div>
        <div class="w-full bg-white/10 rounded-full h-2">
            <div id="syncProgressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="text-xs text-white/60 mt-1">This may take several minutes for large stores</div>
    </div>

    <!-- Orders Table -->
    <div class="glass overflow-hidden">
        <table class="w-full min-w-[1200px]">
            <thead>
                <tr class="border-b border-white/10">
                    <!-- Checkbox for bulk selection -->
                    <th class="p-3 text-left">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="rounded border-white/20 bg-slate-900/60">
                    </th>
                    
                    <!-- Order Information -->
                    <th class="p-3 text-left cursor-pointer hover:bg-white/5" onclick="sortTable('order_number')">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">📦</span>
                            Order #
                            <span id="order_sort_icon" class="text-white/40">↕️</span>
                        </div>
                    </th>
                    
                    <!-- Customer Information -->
                    <th class="p-3 text-left cursor-pointer hover:bg-white/5" onclick="sortTable('customer_name')">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">👤</span>
                            Customer
                            <span id="customer_sort_icon" class="text-white/40">↕️</span>
                        </div>
                    </th>
                    
                    <!-- Contact Information -->
                    <th class="p-3 text-left">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">📧</span>
                            Contact
                        </div>
                    </th>
                    
                    <!-- Order Status -->
                    <th class="p-3 text-left cursor-pointer hover:bg-white/5" onclick="sortTable('status')">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">🔄</span>
                            Status
                            <span id="status_sort_icon" class="text-white/40">↕️</span>
                        </div>
                    </th>
                    
                    <!-- Financial Status -->
                    <th class="p-3 text-left cursor-pointer hover:bg-white/5" onclick="sortTable('financial_status')">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">💰</span>
                            Payment
                            <span id="payment_sort_icon" class="text-white/40">↕️</span>
                        </div>
                    </th>
                    
                    <!-- Fulfillment Status -->
                    <th class="p-3 text-left cursor-pointer hover:bg-white/5" onclick="sortTable('fulfillment_status')">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">📦</span>
                            Fulfillment
                            <span id="fulfillment_sort_icon" class="text-white/40">↕️</span>
                        </div>
                    </th>
                    
                    <!-- Order Value -->
                    <th class="p-3 text-left cursor-pointer hover:bg-white/5" onclick="sortTable('total_price')">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">💵</span>
                            Total
                            <span id="total_sort_icon" class="text-white/40">↕️</span>
                        </div>
                    </th>
                    
                    <!-- Currency -->
                    <th class="p-3 text-left">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">🌍</span>
                            Currency
                        </div>
                    </th>
                    
                    <!-- Items Count -->
                    <th class="p-3 text-left cursor-pointer hover:bg-white/5" onclick="sortTable('items_count')">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">📋</span>
                            Items
                            <span id="items_sort_icon" class="text-white/40">↕️</span>
                        </div>
                    </th>
                    
                    <!-- Shipping Address -->
                    <th class="p-3 text-left">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">📍</span>
                            Shipping
                        </div>
                    </th>
                    
                    <!-- Created Date -->
                    <th class="p-3 text-left cursor-pointer hover:bg-white/5" onclick="sortTable('created_at')">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">📅</span>
                            Created
                            <span id="date_sort_icon" class="text-white/40">↕️</span>
                        </div>
                    </th>
                    
                    <!-- Updated Date -->
                    <th class="p-3 text-left cursor-pointer hover:bg-white/5" onclick="sortTable('updated_at')">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">🔄</span>
                            Updated
                            <span id="updated_sort_icon" class="text-white/40">↕️</span>
                        </div>
                    </th>
                    
                    <!-- Tags -->
                    <th class="p-3 text-left">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">🏷️</span>
                            Tags
                        </div>
                    </th>
                    
                    <!-- Notes -->
                    <th class="p-3 text-left">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">📝</span>
                            Notes
                        </div>
                    </th>
                    
                    <!-- SLA Status -->
                    <th class="p-3 text-left cursor-pointer hover:bg-white/5" onclick="sortTable('sla_status')">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">⏰</span>
                            SLA
                            <span id="sla_sort_icon" class="text-white/40">↕️</span>
                        </div>
                    </th>
                    
                    <!-- Actions -->
                    <th class="p-3 text-left">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-white/60">⚡</span>
                            Actions
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody id="ordersTable">
                <!-- Orders will be populated by JS -->
                <tr>
                    <td colspan="18" class="p-8 text-center text-white/60">
                        Loading orders...
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Load More -->
        <div id="loadMore" class="p-4 text-center hidden">
            <button onclick="loadMoreOrders()" class="btn btn-secondary">
                Load More Orders
            </button>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div id="orderModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
    <div class="absolute inset-6 bg-slate-900 rounded-xl shadow-2xl flex flex-col">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-white/10">
            <h2 class="text-xl font-bold">Order Details</h2>
            <button onclick="closeOrderModal()" class="btn btn-ghost">
                Close
            </button>
        </div>

        <!-- Modal Content -->
        <div class="flex-1 overflow-auto p-6">
            <div id="orderDetails">
                <!-- Order details will be populated by JS -->
            </div>
        </div>
    </div>
</div>

    <!-- Custom CSS for Date Filters -->
    <style>
        .quick-filter {
            @apply px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 cursor-pointer;
        }
        
        .quick-filter:hover {
            @apply transform scale-105;
        }
        
        .quick-filter[onclick^="applyDateFilter"] {
            @apply border border-transparent;
        }
        
        .quick-filter[onclick^="applyDateFilter"].ring-2 {
            @apply transform scale-105 shadow-lg;
        }
    </style>

<!-- Orders JavaScript -->
<script>
let nextCursor = null;
let loading = false;

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    loadMetrics();
    loadOrders();
    
    // Setup search debounce
    const searchInput = document.getElementById('searchInput');
    let debounceTimer;
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            loadOrders(true);
        }, 300);
    });
    
    // Setup other filter changes
    document.getElementById('statusFilter').addEventListener('change', () => loadOrders(true));
    document.getElementById('startDate').addEventListener('change', () => handleManualDateChange());
    document.getElementById('endDate').addEventListener('change', () => handleManualDateChange());
    document.getElementById('paymentFilter').addEventListener('change', () => loadOrders(true));
});

async function loadMetrics(filtered = false) {
    try {
        let url = '/api/orders/metrics';
        
        // If we're filtering by date, pass the date parameters
        if (filtered) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                url += `?start_date=${startDate}&end_date=${endDate}`;
            }
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        // Update metrics cards with real data
        const cards = [
            {
                title: 'Total Orders',
                value: data.metrics?.total_orders || data.total_orders || 0,
                icon: '📊',
                color: 'text-blue-400'
            },
            {
                title: 'Total Revenue',
                value: data.metrics?.total_revenue || '₹0',
                icon: '💰',
                color: 'text-green-400'
            },
            {
                title: 'Paid Orders',
                value: data.metrics?.status_breakdown?.paid || 0,
                icon: '✅',
                color: 'text-green-400'
            },
            {
                title: 'Pending Orders',
                value: data.metrics?.status_breakdown?.pending || 0,
                icon: '⏳',
                color: 'text-yellow-400'
            },
            {
                title: 'Partially Paid',
                value: data.metrics?.status_breakdown?.['partially_paid'] || 0,
                icon: '⚠️',
                color: 'text-orange-400'
            },
            {
                title: 'Today\'s Orders',
                value: data.metrics?.today_orders || 0,
                icon: '📅',
                color: 'text-purple-400'
            },
            {
                title: 'This Week',
                value: data.metrics?.week_orders || 0,
                icon: '📈',
                color: 'text-indigo-400'
            },
            {
                title: 'Last Sync',
                value: data.metrics?.last_sync || 'Never',
                icon: '🔄',
                color: 'text-gray-400'
            }
        ];
        
        // If we don't have metrics data, try to get basic info from orders
        if (!data.metrics && data.orders) {
            const totalOrders = data.orders.length;
            const totalRevenue = data.orders.reduce((sum, order) => sum + (parseFloat(order.total_price) || 0), 0);
            const statusCounts = {};
            
            data.orders.forEach(order => {
                const status = order.status || 'unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            // Update cards with basic data
            cards[0].value = totalOrders;
            cards[1].value = `₹${totalRevenue.toFixed(2)}`;
            cards[2].value = statusCounts.paid || 0;
            cards[3].value = statusCounts.pending || 0;
            cards[4].value = statusCounts['partially_paid'] || 0;
        }
        
        const metricsHtml = cards.map(card => `
            <div class="glass p-4 hover:bg-white/5 transition-colors">
                <div class="flex items-center gap-3">
                    <div class="text-2xl">${card.icon}</div>
                    <div class="flex-1">
                        <div class="text-sm text-white/60">${card.title}</div>
                        <div class="text-2xl font-bold ${card.color}">${card.value}</div>
                    </div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('metricsCards').innerHTML = metricsHtml;
    } catch (error) {
        console.error('Error loading metrics:', error);
    }
}

// loadOrders function moved below with sorting functionality

async function viewOrder(orderId) {
    try {
        const response = await fetch(`/api/orders/${orderId}`);
        const order = await response.json();
        
        // Build order details HTML
        const detailsHtml = `
            <div class="space-y-8">
                <!-- Order Info -->
                <div class="flex items-start justify-between">
                    <div>
                        <h3 class="text-xl font-bold mb-2">#${order.order_number}</h3>
                        <div class="text-sm text-white/60">Shopify ID: ${order.shopify_id}</div>
                    </div>
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm bg-${order.status_display.color}-500/20 text-${order.status_display.color}-300">
                        ${order.status_display.icon} ${order.status_display.label}
                    </span>
                </div>
                
                <!-- Customer Details -->
                <div class="glass p-4">
                    <h4 class="font-medium mb-3">Customer Details</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-white/60">Name</div>
                            <div>${order.customer_name}</div>
                        </div>
                        <div>
                            <div class="text-sm text-white/60">Email</div>
                            <div>${order.email}</div>
                        </div>
                        <div>
                            <div class="text-sm text-white/60">Phone</div>
                            <div>${order.phone || '-'}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Shipping Address -->
                <div class="glass p-4">
                    <h4 class="font-medium mb-3">Shipping Address</h4>
                    <div>${order.shipping_address.name}</div>
                    <div>${order.shipping_address.address1}</div>
                    ${order.shipping_address.address2 ? `<div>${order.shipping_address.address2}</div>` : ''}
                    <div>${order.shipping_address.city}, ${order.shipping_address.state} ${order.shipping_address.pincode}</div>
                    <div>${order.shipping_address.country}</div>
                </div>
                
                <!-- Line Items -->
                <div class="glass p-4">
                    <h4 class="font-medium mb-3">Items</h4>
                    <div class="space-y-4">
                        ${order.line_items.map(item => `
                            <div class="flex items-start gap-4 pb-4 border-b border-white/10 last:border-0">
                                <div class="flex-1">
                                    <div class="font-medium">${item.title}</div>
                                    ${item.variant_title ? `<div class="text-sm text-white/60">${item.variant_title}</div>` : ''}
                                    ${item.sku ? `<div class="text-sm text-white/60">SKU: ${item.sku}</div>` : ''}
                                    ${item.requires_engraving ? `
                                        <div class="mt-2 p-2 bg-purple-500/20 rounded-lg">
                                            <div class="text-sm font-medium text-purple-300">Engraving Required</div>
                                            <div class="text-sm">${item.engraving_text || 'No text specified'}</div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="font-medium">₹${item.price}</div>
                                    <div class="text-sm text-white/60">Qty: ${item.quantity}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Order Totals -->
                    <div class="mt-4 pt-4 border-t border-white/10">
                        <div class="flex justify-between">
                            <div class="text-sm text-white/60">Subtotal</div>
                            <div>₹${order.subtotal_price}</div>
                        </div>
                        <div class="flex justify-between mt-1">
                            <div class="text-sm text-white/60">Shipping</div>
                            <div>₹${order.total_shipping}</div>
                        </div>
                        <div class="flex justify-between mt-1">
                            <div class="text-sm text-white/60">Tax</div>
                            <div>₹${order.total_tax}</div>
                        </div>
                        <div class="flex justify-between mt-1">
                            <div class="text-sm text-white/60">Discounts</div>
                            <div>-₹${order.total_discounts}</div>
                        </div>
                        <div class="flex justify-between mt-2 pt-2 border-t border-white/10 font-bold">
                            <div>Total</div>
                            <div>₹${order.total_price}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fulfillments -->
                ${order.fulfillments.length > 0 ? `
                    <div class="glass p-4">
                        <h4 class="font-medium mb-3">Fulfillments</h4>
                        <div class="space-y-4">
                            ${order.fulfillments.map(f => `
                                <div class="flex items-start justify-between gap-4">
                                    <div>
                                        <div class="font-medium">${f.tracking_company || 'Unknown Carrier'}</div>
                                        <div class="text-sm text-white/60">Status: ${f.status}</div>
                                        ${f.tracking_number ? `
                                            <div class="text-sm text-white/60">Tracking: ${f.tracking_number}</div>
                                        ` : ''}
                                    </div>
                                    <div class="text-right text-sm text-white/60">
                                        ${new Date(f.created_at).toLocaleString()}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Timeline -->
                <div class="glass p-4">
                    <h4 class="font-medium mb-3">Timeline</h4>
                    <div class="space-y-4">
                        ${order.events.map(event => `
                            <div class="flex items-start gap-4">
                                <div class="flex-1">
                                    <div class="font-medium">${event.event_type.replace('_', ' ').toUpperCase()}</div>
                                    ${event.event_type === 'status_change' ? `
                                        <div class="text-sm text-white/60">
                                            ${event.old_value.status} → ${event.new_value.status}
                                            ${event.new_value.note ? `<br>${event.new_value.note}` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-white/60">${new Date(event.created_at).toLocaleString()}</div>
                                    <div class="text-sm text-white/60">${event.actor_name}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('orderDetails').innerHTML = detailsHtml;
        document.getElementById('orderModal').classList.remove('hidden');
    } catch (error) {
        console.error('Error loading order details:', error);
    }
}

function closeOrderModal() {
    document.getElementById('orderModal').classList.add('hidden');
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('paymentFilter').value = '';
    
    // Clear date filter button styling
    const dateButtons = document.querySelectorAll('[onclick^="applyDateFilter"]');
    dateButtons.forEach(btn => {
        btn.classList.remove('ring-2', 'ring-white/50', 'bg-opacity-40');
        btn.classList.add('bg-opacity-20', 'hover:bg-opacity-30');
    });
    
    // Hide date filter status
    hideDateFilterStatus();
    
    loadOrders(true);
    loadMetrics(true);
}

function applyQuickFilter(filter) {
    clearFilters();
    
    switch (filter) {
        case 'pending':
            document.getElementById('statusFilter').value = 'pending';
            break;
        case 'engraving':
            document.getElementById('statusFilter').value = 'processing';
            // TODO: Add custom filter for engraving items
            break;
        case 'packed':
            document.getElementById('statusFilter').value = 'packed';
            break;
        case 'rto':
            // TODO: Add tag filter for RTO
            break;
        case 'disputed':
            document.getElementById('statusFilter').value = 'disputed';
            break;
    }
    
    loadOrders(true);
}

function applyDateFilter(filterType) {
    const today = new Date();
    let startDate, endDate;
    
    switch (filterType) {
        case 'today':
            startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
            break;
        case 'tomorrow':
            startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1, 23, 59, 59);
            break;
        case 'last7':
            startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 6);
            endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
            break;
        case 'last30':
            startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 29);
            endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
            break;
        default:
            return;
    }
    
    // Format dates for input fields (YYYY-MM-DD)
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    // Set the date inputs
    document.getElementById('startDate').value = formatDate(startDate);
    document.getElementById('endDate').value = formatDate(endDate);
    
    // Update active filter button styling
    updateActiveDateFilter(filterType);
    
    // Show date filter status
    showDateFilterStatus(filterType, startDate, endDate);
    
    // Load orders with the new date filter
    loadOrders(true);
    
    // Update metrics for the filtered period
    loadMetrics(true);
}

function updateActiveDateFilter(activeFilter) {
    // Remove active styling from all date filter buttons
    const dateButtons = document.querySelectorAll('[onclick^="applyDateFilter"]');
    dateButtons.forEach(btn => {
        btn.classList.remove('ring-2', 'ring-white/50');
        btn.classList.add('bg-opacity-20', 'hover:bg-opacity-30');
    });
    
    // Add active styling to the clicked button
    const activeButton = document.querySelector(`[onclick="applyDateFilter('${activeFilter}')"]`);
    if (activeButton) {
        activeButton.classList.add('ring-2', 'ring-white/50');
        activeButton.classList.remove('bg-opacity-20', 'hover:bg-opacity-30');
        activeButton.classList.add('bg-opacity-40');
    }
}

function clearDateFilter() {
    // Clear date inputs
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    
    // Remove active styling from all date filter buttons
    const dateButtons = document.querySelectorAll('[onclick^="applyDateFilter"]');
    dateButtons.forEach(btn => {
        btn.classList.remove('ring-2', 'ring-white/50', 'bg-opacity-40');
        btn.classList.add('bg-opacity-20', 'hover:bg-opacity-30');
    });
    
    // Hide date filter status
    hideDateFilterStatus();
    
    // Load orders without date filter
    loadOrders(true);
    
    // Update metrics for all orders
    loadMetrics(true);
}

async function syncOrders() {
    try {
        // Show loading state
        const syncButton = document.querySelector('button[onclick="syncOrders()"]');
        const originalText = syncButton.innerHTML;
        syncButton.innerHTML = '<span class="icon">⏳</span> Syncing...';
        syncButton.disabled = true;
        
        // Call instant sync endpoint
        const response = await fetch('/api/shopify/instant-sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show success message
            showSyncNotification(data.message, 'success');
            
            // Show latest orders if any
            if (data.latest_orders && data.latest_orders.length > 0) {
                showLatestOrders(data.latest_orders);
            }
            
            // Refresh the page data
            setTimeout(() => {
                loadMetrics();
                loadOrders(true);
            }, 1000);
            
        } else {
            showSyncNotification(data.error || 'Sync failed', 'error');
        }
        
    } catch (error) {
        console.error('Error syncing orders:', error);
        showSyncNotification('Failed to sync orders: ' + error.message, 'error');
    } finally {
        // Reset button state
        const syncButton = document.querySelector('button[onclick="syncOrders()"]');
        syncButton.innerHTML = originalText;
        syncButton.disabled = false;
    }
}

function showSyncNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    let bgColor, icon, title;
    
    switch (type) {
        case 'success':
            bgColor = 'bg-green-600 text-white';
            icon = '✅';
            title = 'Sync Successful';
            break;
        case 'error':
            bgColor = 'bg-red-600 text-white';
            icon = '❌';
            title = 'Sync Failed';
            break;
        case 'warning':
            bgColor = 'bg-yellow-600 text-white';
            icon = '⚠️';
            title = 'Sync Warning';
            break;
        default:
            bgColor = 'bg-blue-600 text-white';
            icon = 'ℹ️';
            title = 'Sync Info';
    }
    
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-md ${bgColor}`;
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="text-xl">${icon}</span>
            <div>
                <div class="font-medium">${title}</div>
                <div class="text-sm opacity-90">${message}</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function showLatestOrders(orders) {
    // Create modal to show latest synced orders
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center';
    modal.innerHTML = `
        <div class="bg-slate-800 rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-white/10">
                <h2 class="text-xl font-bold">🔄 Latest Synced Orders</h2>
                <button onclick="this.closest('.fixed').remove()" class="btn btn-ghost">✕</button>
            </div>
            <div class="p-6 overflow-auto max-h-[60vh]">
                <div class="space-y-4">
                    ${orders.map(order => `
                        <div class="glass p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium">#${order.order_number}</div>
                                    <div class="text-sm text-white/60">${order.customer}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-medium">₹${order.total}</div>
                                    <div class="text-sm text-white/60">${order.status}</div>
                                    <div class="text-xs text-white/40">${new Date(order.created).toLocaleDateString()}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
        modal.remove();
    }, 10000);
}

async function fullSyncOrders() {
    try {
        // Show loading state
        const fullSyncButton = document.querySelector('button[onclick="fullSyncOrders()"]');
        const originalText = fullSyncButton.innerHTML;
        fullSyncButton.innerHTML = '<span class="icon">⏳</span> Full Syncing...';
        fullSyncButton.disabled = true;
        
        // Call full sync endpoint
        const response = await fetch('/api/shopify/full-sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSyncNotification('Full sync started in background - this will fetch ALL orders', 'success');
            
            // Show progress bar
            document.getElementById('syncProgress').classList.remove('hidden');
            document.getElementById('syncStatus').textContent = 'Starting full sync...';
            document.getElementById('syncProgressBar').style.width = '10%';
            
            // Start polling for sync status
            pollSyncStatus();
            
        } else {
            showSyncNotification(data.error || 'Full sync failed', 'error');
        }
        
    } catch (error) {
        console.error('Error starting full sync:', error);
        showSyncNotification('Failed to start full sync: ' + error.message, 'error');
    } finally {
        // Reset button state
        const fullSyncButton = document.querySelector('button[onclick="fullSyncOrders()"]');
        fullSyncButton.innerHTML = originalText;
        fullSyncButton.disabled = false;
    }
}

async function pollSyncStatus() {
    let attempts = 0;
    const maxAttempts = 60; // Poll for up to 5 minutes
    
    const poll = async () => {
        try {
            const response = await fetch('/api/shopify/sync-status');
            const data = await response.json();
            
            if (data.success && data.status) {
                const status = data.status;
                
                            if (status.status === 'success') {
                showSyncNotification(`Full sync completed! ${status.orders_synced} orders synced`, 'success');
                // Hide progress bar
                document.getElementById('syncProgress').classList.add('hidden');
                // Refresh page data
                setTimeout(() => {
    loadMetrics();
    loadOrders(true);
                }, 1000);
                return;
            } else if (status.status === 'error') {
                showSyncNotification(`Full sync failed: ${status.error_message || 'Unknown error'}`, 'error');
                // Hide progress bar
                document.getElementById('syncProgress').classList.add('hidden');
                return;
            }
            }
            
            attempts++;
            if (attempts < maxAttempts) {
                // Update progress bar
                const progress = Math.min((attempts / maxAttempts) * 100, 90);
                document.getElementById('syncProgressBar').style.width = progress + '%';
                document.getElementById('syncStatus').textContent = `Syncing... (${attempts}/${maxAttempts} attempts)`;
                
                // Continue polling every 5 seconds
                setTimeout(poll, 5000);
            } else {
                showSyncNotification('Full sync is taking longer than expected. Check server logs.', 'warning');
                // Hide progress bar
                document.getElementById('syncProgress').classList.add('hidden');
            }
            
        } catch (error) {
            console.error('Error polling sync status:', error);
            attempts++;
            if (attempts < maxAttempts) {
                setTimeout(poll, 5000);
            }
        }
    };
    
    // Start polling
    poll();
}

function showDateFilterStatus(filterType, startDate, endDate) {
    const statusDiv = document.getElementById('dateFilterStatus');
    const rangeSpan = document.getElementById('dateFilterRange');
    
    let filterText = '';
    switch (filterType) {
        case 'today':
            filterText = 'Today';
            break;
        case 'tomorrow':
            filterText = 'Tomorrow';
            break;
        case 'last7':
            filterText = 'Last 7 Days';
            break;
        case 'last30':
            filterText = 'Last 30 Days';
            break;
        default:
            filterText = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
    }
    
    rangeSpan.textContent = filterText;
    statusDiv.classList.remove('hidden');
}

function hideDateFilterStatus() {
    document.getElementById('dateFilterStatus').classList.add('hidden');
}

function handleManualDateChange() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    // Clear active date filter button styling
    const dateButtons = document.querySelectorAll('[onclick^="applyDateFilter"]');
    dateButtons.forEach(btn => {
        btn.classList.remove('ring-2', 'ring-white/50', 'bg-opacity-40');
        btn.classList.add('bg-opacity-20', 'hover:bg-opacity-30');
    });
    
    // Show custom date range status if both dates are set
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        showCustomDateFilterStatus(start, end);
    } else {
        hideDateFilterStatus();
    }
    
    // Load orders and metrics with the new date filter
    loadOrders(true);
    loadMetrics(true);
}

function showCustomDateFilterStatus(startDate, endDate) {
    const statusDiv = document.getElementById('dateFilterStatus');
    const rangeSpan = document.getElementById('dateFilterRange');
    
    const formatDate = (date) => {
        return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric' 
        });
    };
    
    rangeSpan.textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
    statusDiv.classList.remove('hidden');
}

function refreshOrders() {
    loadMetrics(true);
    loadOrders(true);
}

// Sorting functionality
let currentSort = { field: null, direction: 'asc' };
let allOrders = []; // Store all orders for sorting

function sortTable(field) {
    const orderIcon = document.getElementById('order_sort_icon');
    const dateIcon = document.getElementById('date_sort_icon');
    
    // Reset all icons
    orderIcon.textContent = '↕️';
    dateIcon.textContent = '↕️';
    
    // Determine sort direction
    if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
    }
    
    // Update icon for current sort field
    const icon = field === 'order_number' ? orderIcon : dateIcon;
    icon.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
    
    // Sort the orders
    sortOrders();
}

function sortOrders() {
    if (!allOrders.length) return;
    
    const sortedOrders = [...allOrders].sort((a, b) => {
        let aVal, bVal;
        
        if (currentSort.field === 'order_number') {
            // Extract numeric part from order number for proper sorting
            aVal = parseInt(a.order_number.replace(/\D/g, '')) || 0;
            bVal = parseInt(b.order_number.replace(/\D/g, '')) || 0;
        } else if (currentSort.field === 'created_at') {
            aVal = new Date(a.created_at).getTime();
            bVal = new Date(b.created_at).getTime();
        } else {
            return 0;
        }
        
        if (currentSort.direction === 'asc') {
            return aVal - bVal;
        } else {
            return bVal - aVal;
        }
    });
    
    // Update table with sorted orders
    updateOrdersTable(sortedOrders);
}

function updateOrdersTable(orders) {
    const ordersHtml = orders.map(order => `
        <tr class="border-b border-white/10 hover:bg-white/5">
            <td class="p-4">
                <div class="font-medium">#${order.order_number}</div>
                <div class="text-sm text-white/60">${order.shopify_id}</div>
            </td>
            <td class="p-4">
                <div class="font-medium">${order.customer_name}</div>
                <div class="text-sm text-white/60">${order.email}</div>
                <div class="text-sm text-white/60">${order.phone || '-'}</div>
            </td>
            <td class="p-4">
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-sm bg-${order.status_display.color}-500/20 text-${order.status_display.color}-300">
                    ${order.status_display.icon} ${order.status_display.label}
                </span>
            </td>
            <td class="p-4">
                <div class="font-medium">₹${order.total_price}</div>
                <div class="text-sm text-white/60">${order.payment_method.toUpperCase()}</div>
            </td>
            <td class="p-4">
                <div class="font-medium">${new Date(order.created_at).toLocaleDateString()}</div>
                <div class="text-sm text-white/60">${new Date(order.created_at).toLocaleTimeString()}</div>
            </td>
            <td class="p-4">
                ${order.sla_due_at ? `
                    <div class="font-medium ${order.sla_breached ? 'text-red-400' : ''}">${new Date(order.sla_due_at).toLocaleDateString()}</div>
                    <div class="text-sm text-white/60">${new Date(order.sla_due_at).toLocaleTimeString()}</div>
                ` : '-'}
            </td>
            <td class="p-4">
                <button onclick="viewOrder('${order.id}')" class="btn btn-ghost">
                    View
                </button>
            </td>
        </tr>
    `).join('');
    
    document.getElementById('ordersTable').innerHTML = ordersHtml;
}

// Update loadOrders function to store orders for sorting
async function loadOrders(reset = false) {
    if (loading) return;
    loading = true;
    
    if (reset) {
        nextCursor = null;
        document.getElementById('ordersTable').innerHTML = '';
        allOrders = []; // Reset stored orders
    }
    
    try {
        // Build query params
        const params = new URLSearchParams();
        
        const search = document.getElementById('searchInput').value;
        if (search) params.append('q', search);
        
        const status = document.getElementById('statusFilter').value;
        if (status) params.append('status', status);
        
        const startDate = document.getElementById('startDate').value;
        if (startDate) params.append('start_date', startDate);
        
        const endDate = document.getElementById('endDate').value;
        if (endDate) params.append('end_date', endDate);
        
        const payment = document.getElementById('paymentFilter').value;
        if (payment) params.append('payment_method', payment);
        
        if (nextCursor) params.append('cursor', nextCursor);
        
        // Fetch orders
        const response = await fetch(`/api/orders?${params.toString()}`);
        const data = await response.json();
        
        // Store orders for sorting
        if (reset) {
            allOrders = data.orders || [];
        } else {
            allOrders = [...allOrders, ...(data.orders || [])];
        }
        
        // Apply current sort if any
        if (currentSort.field) {
            sortOrders();
        } else {
            // Update table normally
            updateOrdersTable(data.orders || []);
        }
        
        // Update load more button
        const loadMore = document.getElementById('loadMore');
        if (data.next_cursor) {
            nextCursor = data.next_cursor;
            loadMore.classList.remove('hidden');
        } else {
            nextCursor = null;
            loadMore.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error loading orders:', error);
    } finally {
        loading = false;
    }
}
</script>
{% endblock %}
