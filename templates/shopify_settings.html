{% extends "layout_base.html" %}
{% block content %}

<section class="glass p-6">
  <div class="flex items-center gap-3 mb-6">
    <div class="text-4xl">üõí</div>
    <div>
      <h1 class="text-3xl font-bold">Shopify Integration Settings</h1>
      <p class="text-white/80 mt-1">Connect your Shopify store to automatically sync orders and analytics with your dashboard.</p>
    </div>
  </div>
  
  <!-- Connection Status Banner -->
  <div id="connectionBanner" class="hidden mb-6">
    <div id="successBanner" class="hidden bg-green-500/20 border border-green-500/30 text-green-200 p-4 rounded-xl">
      <div class="flex items-center gap-2">
        <div class="text-xl">‚úÖ</div>
        <div>
          <div class="font-semibold">Shopify store connected successfully!</div>
          <div class="text-sm text-green-200/80">Click "Instant Sync" to sync orders immediately, or they'll sync automatically every 10 minutes.</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Saved Configuration Status -->
  <div id="savedConfigStatus" class="hidden mb-6">
    <div class="bg-blue-500/20 border border-blue-500/30 text-blue-200 p-4 rounded-xl">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="text-xl">üîê</div>
          <div>
            <div class="font-semibold">Credentials Saved & Auto-Connection Enabled</div>
            <div class="text-sm text-blue-200/80">Your store credentials are securely saved. The system will automatically connect on startup.</div>
          </div>
        </div>
        <button onclick="clearSavedCredentials()" class="text-blue-300 hover:text-blue-100 text-sm underline">
          Clear Saved Credentials
        </button>
      </div>
    </div>
  </div>
  
  <div class="mt-6 grid gap-6">
    <!-- Configuration Form -->
    <div class="glass p-5">
      <h2 class="text-xl font-semibold mb-4">Store Configuration</h2>
      
      <form id="shopifyConfigForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Store Name</label>
          <div class="relative">
            <input type="text" id="shopDomain" placeholder="407f1f-4" 
                   class="w-full rounded-xl bg-slate-900/60 border border-white/10 px-3 py-2 text-white placeholder-white/50 pr-12">
            <div id="domainStatus" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-sm hidden">
              <span id="domainSavedIcon" class="text-green-400">üîí</span>
            </div>
          </div>
          <p class="text-xs text-white/60 mt-1">Enter just the store name part (e.g., "my-store" for my-store.myshopify.com)</p>
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Private App Access Token</label>
          <div class="relative">
            <input type="password" id="accessToken" placeholder="Enter your Shopify access token"
                   class="w-full rounded-xl bg-slate-900/60 border border-white/10 px-3 py-2 text-white placeholder-white/50 pr-12">
            <div id="tokenStatus" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-sm hidden">
              <span id="tokenSavedIcon" class="text-green-400">üîí</span>
            </div>
          </div>
          <p class="text-xs text-white/60 mt-1">Get this from your Shopify Admin ‚Üí Apps ‚Üí Private Apps</p>
        </div>
        
        <div class="flex items-center gap-2">
          <input type="checkbox" id="rememberCredentials" class="rounded border-white/20 bg-slate-900/60">
          <label for="rememberCredentials" class="text-sm text-white/80">Remember credentials for auto-connection</label>
        </div>
        
        <div class="flex gap-3">
          <button type="button" id="connectStore" class="btn btn-primary flex items-center gap-2">
            <span>üîó</span> Connect Store
          </button>
          <button type="button" id="testConnection" class="btn btn-secondary flex items-center gap-2">
            <span>üß™</span> Test Connection
          </button>
          <button type="button" id="syncNow" class="btn btn-accent flex items-center gap-2" disabled>
            <span>‚ö°</span> Instant Sync
          </button>
        </div>
      </form>
    </div>
    
    <!-- Connection Status -->
    <div class="glass p-5">
      <h2 class="text-xl font-semibold mb-4">Connection Status</h2>
      <div id="connectionStatus" class="space-y-2">
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
          <span>Checking connection...</span>
        </div>
      </div>
    </div>
    
    <!-- Store Information -->
    <div class="glass p-5">
      <h2 class="text-xl font-semibold mb-4">Store Information</h2>
      <div id="storeInfo" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-slate-800/50 p-4 rounded-lg">
          <div class="text-sm text-white/60">Store Name</div>
          <div id="storeName" class="text-lg font-medium">-</div>
        </div>
        <div class="bg-slate-800/50 p-4 rounded-lg">
          <div class="text-sm text-white/60">Total Products</div>
          <div id="totalProducts" class="text-lg font-medium">-</div>
        </div>
        <div class="bg-slate-800/50 p-4 rounded-lg">
          <div class="text-sm text-white/60">Total Orders</div>
          <div id="totalOrders" class="text-lg font-medium">-</div>
        </div>
        <div class="bg-slate-800/50 p-4 rounded-lg">
          <div class="text-sm text-white/60">Plan</div>
          <div id="storePlan" class="text-lg font-medium">-</div>
        </div>
      </div>
    </div>
    
    <!-- API Usage -->
    <div class="glass p-5">
      <h2 class="text-xl font-semibold mb-4">API Usage</h2>
      <div class="bg-slate-800/50 p-4 rounded-lg">
        <div class="flex justify-between items-center">
          <span>API Calls Today</span>
          <span id="apiUsage" class="font-medium">0 / 10000</span>
        </div>
        <div class="w-full bg-slate-700 rounded-full h-2 mt-2">
          <div id="apiUsageBar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .status-connected { color: #10b981; }
  .status-error { color: #ef4444; }
  .status-warning { color: #f59e0b; }
</style>

<script>
// Shopify settings functionality
var connectBtn = document.getElementById('connectStore');
var testBtn = document.getElementById('testConnection');
var syncBtn = document.getElementById('syncNow');
var shopDomain = document.getElementById('shopDomain');
var accessToken = document.getElementById('accessToken');
var connectionStatus = document.getElementById('connectionStatus');
var connectionBanner = document.getElementById('connectionBanner');
var successBanner = document.getElementById('successBanner');
var storeName = document.getElementById('storeName');
var totalProducts = document.getElementById('totalProducts');
var totalOrders = document.getElementById('totalOrders');
var storePlan = document.getElementById('storePlan');
var apiUsage = document.getElementById('apiUsage');
var apiUsageBar = document.getElementById('apiUsageBar');

function connectStore() {
  connectBtn.disabled = true;
  connectBtn.innerHTML = '<span>‚è≥</span> Connecting...';
  
  var config = {
    shop_domain: shopDomain.value.trim(),
    access_token: accessToken.value.trim()
  };
  
  if (!config.shop_domain || !config.access_token) {
    showNotification('Please fill in both store name and access token', 'error');
    connectBtn.disabled = false;
    connectBtn.innerHTML = '<span>üîó</span> Connect Store';
    return;
  }
  
  fetch('/api/shopify/config', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(config)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('Store connected successfully!', 'success');
      showSuccessBanner();
      showSavedConfigStatus();
      loadStoreInfo();
      syncBtn.disabled = false;
    } else {
      showNotification('Failed to connect: ' + (data.detail || data.error), 'error');
    }
  })
  .catch(error => {
    showNotification('Error connecting: ' + error.message, 'error');
  })
  .finally(() => {
    connectBtn.disabled = false;
    connectBtn.innerHTML = '<span>üîó</span> Connect Store';
  });
}

function testConnection() {
  testBtn.disabled = true;
  testBtn.innerHTML = '<span>‚è≥</span> Testing...';
  
  connectionStatus.innerHTML = `
    <div class="flex items-center gap-2">
      <div class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
      <span>Testing connection...</span>
    </div>
  `;
  
  fetch('/api/shopify/test')
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      connectionStatus.innerHTML = `
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full bg-green-500"></div>
          <span class="status-connected">Connected successfully!</span>
        </div>
      `;
      loadStoreInfo();
      syncBtn.disabled = false;
    } else {
      connectionStatus.innerHTML = `
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full bg-red-500"></div>
          <span class="status-error">Connection failed: ${data.error}</span>
        </div>
      `;
    }
  })
  .catch(error => {
    connectionStatus.innerHTML = `
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full bg-red-500"></div>
        <span class="status-error">Network error: ${error.message}</span>
      </div>
    `;
  })
  .finally(() => {
    testBtn.disabled = false;
    testBtn.innerHTML = '<span>üß™</span> Test Connection';
  });
}

function syncNow() {
  syncBtn.disabled = true;
  syncBtn.innerHTML = '<span>‚ö°</span> Syncing...';
  
  fetch('/api/shopify/instant-sync', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification(`‚úÖ ${data.message}`, 'success');
      
      // Show latest orders if available
      if (data.latest_orders && data.latest_orders.length > 0) {
        showLatestOrders(data.latest_orders);
      }
      
      // Reload store info after sync
      setTimeout(loadStoreInfo, 2000);
    } else {
      showNotification('‚ùå ' + (data.error || 'Sync failed'), 'error');
    }
  })
  .catch(error => {
    showNotification('‚ùå Error starting sync: ' + error.message, 'error');
  })
  .finally(() => {
    syncBtn.disabled = false;
    syncBtn.innerHTML = '<span>‚ö°</span> Instant Sync';
  });
}

function showLatestOrders(orders) {
  // Create modal to show latest synced orders
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center';
  modal.innerHTML = `
    <div class="bg-slate-800 rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
      <div class="flex items-center justify-between p-6 border-b border-white/10">
        <h2 class="text-xl font-bold">üîÑ Latest Synced Orders</h2>
        <button onclick="this.closest('.fixed').remove()" class="btn btn-ghost">‚úï</button>
      </div>
      <div class="p-6 overflow-auto max-h-[60vh]">
        <div class="space-y-4">
          ${orders.map(order => `
            <div class="glass p-4 rounded-lg">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-medium">#${order.order_number}</div>
                  <div class="text-sm text-white/60">${order.customer}</div>
                </div>
                <div class="text-right">
                  <div class="font-medium">‚Çπ${order.total}</div>
                  <div class="text-sm text-white/60">${order.status}</div>
                  <div class="text-xs text-white/40">${new Date(order.created).toLocaleDateString()}</div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Auto-remove after 15 seconds
  setTimeout(() => {
    modal.remove();
  }, 15000);
}

function showSuccessBanner() {
  connectionBanner.classList.remove('hidden');
  successBanner.classList.remove('hidden');
}

function loadStoreInfo() {
  fetch('/api/shopify/store-info')
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      var store = data.store;
      storeName.textContent = store.name || '-';
      totalProducts.textContent = store.product_count || '-';
      totalOrders.textContent = store.order_count || '-';
      storePlan.textContent = store.plan_name || '-';
    }
  })
  .catch(error => {
    console.error('Error loading store info:', error);
  });
}

function loadConfiguration() {
  fetch('/api/shopify/config')
  .then(response => response.json())
  .then(data => {
    if (data.success && data.config) {
      shopDomain.value = data.config.shop_domain || '';
      // Don't populate sensitive fields for security
      
      // Show saved configuration status
      showSavedConfigStatus();
      
      // Show that credentials are saved
      showNotification('üîê Credentials loaded from saved configuration', 'info');
      
      // Auto-test connection if we have saved config
      if (data.config.has_token) {
        showNotification('üîÑ Auto-connecting to saved store...', 'info');
        setTimeout(() => testConnection(), 1000);
      }
    } else {
      // No saved configuration
      hideSavedConfigStatus();
      showNotification('üìù No saved configuration found. Please enter your store details.', 'info');
    }
  })
  .catch(error => {
    console.error('Error loading configuration:', error);
    showNotification('‚ùå Error loading saved configuration', 'error');
    hideSavedConfigStatus();
  });
}

function showSavedConfigStatus() {
  document.getElementById('savedConfigStatus').classList.remove('hidden');
  document.getElementById('domainStatus').classList.remove('hidden');
  document.getElementById('tokenStatus').classList.remove('hidden');
  document.getElementById('rememberCredentials').checked = true;
}

function hideSavedConfigStatus() {
  document.getElementById('savedConfigStatus').classList.add('hidden');
  document.getElementById('domainStatus').classList.add('hidden');
  document.getElementById('tokenStatus').classList.add('hidden');
  document.getElementById('rememberCredentials').checked = false;
}

function clearSavedCredentials() {
  if (confirm('Are you sure you want to clear your saved credentials? You will need to re-enter them.')) {
    fetch('/api/shopify/config', {
      method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification('üóëÔ∏è Saved credentials cleared successfully', 'success');
        hideSavedConfigStatus();
        shopDomain.value = '';
        accessToken.value = '';
        connectionStatus.innerHTML = `
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
            <span>No credentials saved</span>
          </div>
        `;
      } else {
        showNotification('‚ùå Failed to clear credentials: ' + data.error, 'error');
      }
    })
    .catch(error => {
      showNotification('‚ùå Error clearing credentials: ' + error.message, 'error');
    });
  }
}

function showNotification(message, type = 'info') {
  var notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 z-50 p-4 rounded-xl border max-w-md shadow-lg transition-all duration-300 transform translate-x-full`;
  
  if (type === 'success') {
    notification.className += ' bg-green-500/20 border-green-500/30 text-green-200';
  } else if (type === 'error') {
    notification.className += ' bg-red-500/20 border-red-500/30 text-red-200';
  } else {
    notification.className += ' bg-blue-500/20 border-blue-500/30 text-blue-200';
  }
  
  notification.innerHTML = `
    <div class="flex items-center gap-3">
      <div class="text-xl">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</div>
      <div class="flex-1">${message}</div>
      <button onclick="this.parentElement.parentElement.remove()" class="text-white/70 hover:text-white">‚úï</button>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.classList.remove('translate-x-full');
  }, 100);
  
  setTimeout(() => {
    notification.classList.add('translate-x-full');
    setTimeout(() => notification.remove(), 300);
  }, 5000);
}

// Event listeners
connectBtn.onclick = connectStore;
testBtn.onclick = testConnection;
syncBtn.onclick = syncNow;

// Load existing configuration on page load
document.addEventListener('DOMContentLoaded', function() {
  loadConfiguration();
  
  // Auto-connect on startup if credentials are saved
  setTimeout(() => {
    if (document.getElementById('savedConfigStatus').classList.contains('hidden') === false) {
      // Credentials are saved, auto-connect
      showNotification('üöÄ Auto-connecting to saved store...', 'info');
      testConnection();
    }
  }, 2000);
});
</script>

{% endblock %}
