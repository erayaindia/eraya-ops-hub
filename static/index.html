<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eraya Style — CSV to Images/CSVs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#a78bfa; --brand-strong:#8b5cf6; --accent:#f0abfc; }
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:1rem;padding:.7rem 1.1rem;font-weight:700;box-shadow:0 6px 20px rgba(168,139,250,.25), inset 0 1px 0 rgba(255,255,255,.08);}    
    .btn-primary{background:linear-gradient(135deg,var(--brand-strong),var(--accent));color:#0b0416}
    .btn-secondary{background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,.2)}
    .glass{backdrop-filter:blur(10px);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.12);border-radius:1.25rem;}
    .field{display:grid;gap:.35rem}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  </style>
</head>
<body class="min-h-screen text-white bg-gradient-to-br from-slate-950 via-indigo-950 to-fuchsia-900">
  <header class="sticky top-0 z-10 backdrop-blur bg-slate-900/40 border-b border-white/10">
    <div class="mx-auto max-w-5xl px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl" style="background:linear-gradient(135deg,var(--brand),var(--accent))"></div>
        <div class="text-xl font-semibold tracking-wide">Eraya Style</div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-10">
    <section class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold">CSV → Organized Images & Reports</h1>
      <p class="mt-3 text-white/80">Upload your Shopify CSV. We’ll download photos, make polaroids/back messages, and export per-product folders + CSVs.</p>
    </section>

    <section class="glass p-6 space-y-5">
      <div class="border-2 border-dashed border-white/20 rounded-2xl p-6 text-center" id="drop">
        <input id="file" name="file" type="file" accept=".csv,text/csv" class="hidden">
        <p class="text-white/80 mb-3">Drag & drop your CSV here or</p>
        <button id="pick" class="btn btn-secondary">Choose CSV</button>
        <div id="fname" class="mt-3 text-white/70 text-sm"></div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="field">
          <label class="text-white/80 text-sm">Order prefix filter</label>
          <input id="order_prefix" class="rounded-xl bg-slate-900/60 border border-white/10 px-4 py-2" value="#ER">
          <div class="text-xs text-white/60">Only process orders starting with this (example: <code>#ER</code>).</div>
        </div>
        <div class="field">
          <label class="text-white/80 text-sm">Max threads (1–32)</label>
          <input id="max_threads" type="number" min="1" max="32" value="8" class="rounded-xl bg-slate-900/60 border border-white/10 px-4 py-2">
          <div class="text-xs text-white/60">Higher = faster but uses more CPU.</div>
        </div>
        <div class="field">
          <label class="text-white/80 text-sm">HTTP retry count</label>
          <input id="retry_total" type="number" min="0" max="10" value="3" class="rounded-xl bg-slate-900/60 border border-white/10 px-4 py-2">
        </div>
        <div class="field">
          <label class="text-white/80 text-sm">Retry backoff factor</label>
          <input id="backoff_factor" type="number" step="0.1" min="0" value="0.6" class="rounded-xl bg-slate-900/60 border border-white/10 px-4 py-2">
        </div>
        <div class="field">
          <label class="text-white/80 text-sm">HTTP timeout (seconds)</label>
          <input id="timeout_sec" type="number" min="5" max="60" value="15" class="rounded-xl bg-slate-900/60 border border-white/10 px-4 py-2">
        </div>
        <div class="field">
          <label class="text-white/80 text-sm">ZIP name (base)</label>
          <input id="zip_name" value="results" class="rounded-xl bg-slate-900/60 border border-white/10 px-4 py-2">
        </div>
        <div class="field">
          <label class="inline-flex items-center gap-2"><input id="include_pp" type="checkbox" checked> Include per-product CSV</label>
        </div>
        <div class="field">
          <label class="inline-flex items-center gap-2"><input id="include_back" type="checkbox" checked> Include back messages CSV</label>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button id="start" class="btn btn-primary disabled:opacity-50" disabled>Process Orders</button>
        <div id="status" class="text-white/80 text-sm"></div>
      </div>

      <div class="w-full bg-white/10 rounded-xl h-3 overflow-hidden">
        <div id="bar" class="h-3 bg-fuchsia-400 transition-all duration-300" style="width:0%"></div>
      </div>

      <div id="download" class="hidden">
        <a id="dl" class="btn btn-primary" href="#" download>Download Results ZIP</a>
      </div>
    </section>
  </main>

  <footer class="border-t border-white/10 py-8 text-center text-white/70">Built with ❤️ — Eraya Style</footer>

<script>
const el = (id)=>document.getElementById(id);
const fileInput = el('file');
const pickBtn = el('pick');
const startBtn = el('start');
const fname = el('fname');
const statusEl = el('status');
const bar = el('bar');
const dlWrap = el('download');
const dl = el('dl');
const drop = document.getElementById('drop');

const order_prefix = el('order_prefix');
const max_threads = el('max_threads');
const retry_total = el('retry_total');
const backoff_factor = el('backoff_factor');
const timeout_sec = el('timeout_sec');
const zip_name = el('zip_name');
const include_pp = el('include_pp');
const include_back = el('include_back');

let selectedFile = null;
let jobId = null;
let pollTimer = null;

pickBtn.onclick = () => fileInput.click();
fileInput.onchange = () => {
  if (fileInput.files.length) {
    selectedFile = fileInput.files[0];
    fname.textContent = selectedFile.name;
    startBtn.disabled = false;
    startBtn.classList.remove('disabled');
  }
};

drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.classList.add('ring-2','ring-fuchsia-400'); });
drop.addEventListener('dragleave', () => drop.classList.remove('ring-2','ring-fuchsia-400'));
drop.addEventListener('drop', (e) => {
  e.preventDefault();
  drop.classList.remove('ring-2','ring-fuchsia-400');
  if (e.dataTransfer.files.length) {
    selectedFile = e.dataTransfer.files[0];
    if (!/\.csv$/i.test(selectedFile.name)) { alert("Please drop a CSV file."); return; }
    fname.textContent = selectedFile.name;
    startBtn.disabled = false;
  }
});

startBtn.onclick = async () => {
  if (!selectedFile) return;
  statusEl.textContent = "Uploading...";
  bar.style.width = "10%";
  dlWrap.classList.add('hidden');

  const fd = new FormData();
  fd.append('file', selectedFile);
  fd.append('order_prefix', order_prefix.value || '#ER');
  fd.append('max_threads', max_threads.value || '8');
  fd.append('retry_total', retry_total.value || '3');
  fd.append('backoff_factor', backoff_factor.value || '0.6');
  fd.append('timeout_sec', timeout_sec.value || '15');
  fd.append('zip_name', zip_name.value || 'results');
  fd.append('include_per_product_csv', include_pp.checked ? 'true' : 'false');
  fd.append('include_back_messages_csv', include_back.checked ? 'true' : 'false');

  const res = await fetch('/api/process', { method: 'POST', body: fd });
  if (!res.ok) { statusEl.textContent = "Upload failed."; return; }
  const data = await res.json();
  jobId = data.job_id;
  statusEl.textContent = "Processing...";
  bar.style.width = "20%";
  pollTimer = setInterval(poll, 1000);
};

async function poll(){
  const res = await fetch(`/api/status/${jobId}`);
  if (!res.ok) { statusEl.textContent = "Status check failed."; clearInterval(pollTimer); return; }
  const data = await res.json();
  statusEl.textContent = data.message || data.status;
  const p = Math.max(20, Math.min(100, data.progress || 20));
  bar.style.width = p + "%";

  if (data.status === "done") {
    clearInterval(pollTimer);
    statusEl.textContent = "Completed";
    bar.style.width = "100%";
    dl.href = `/api/download/${jobId}`;
    dlWrap.classList.remove('hidden');
  }
  if (data.status === "error") {
    clearInterval(pollTimer);
    alert(data.message || "Processing error.");
  }
}
</script>
</body>
</html>
